<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>课程管理系统 - 管理员主页</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #5c4cf4;
            --bg-color: #f4f7fe;
            --sidebar-bg: #ffffff;
            --text-main: #2b3674;
            --text-secondary: #a3aed0;
            --card-shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
        }

        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            background-color: var(--bg-color);
            color: var(--text-main);
            display: flex;
            min-height: 100vh;
        }

        /* 侧边栏 */
        .sidebar {
            width: 260px;
            background: var(--sidebar-bg);
            border-right: 1px solid #e0e5f2;
            padding: 30px 20px;
            display: flex;
            flex-direction: column;
        }

        .logo {
            font-size: 24px;
            font-weight: bold;
            color: var(--primary-color);
            margin-bottom: 40px;
            padding-left: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .menu-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            text-decoration: none;
            color: var(--text-secondary);
            border-radius: 12px;
            margin-bottom: 8px;
            transition: all 0.3s;
            border: none;
            background: none;
            width: 100%;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
        }

        .menu-item:hover, .menu-item.active {
            background-color: #f7f8fe;
            color: var(--primary-color);
        }

        .menu-item.active {
            border-right: 4px solid var(--primary-color);
            border-radius: 12px 0 0 12px;
        }

        /* 主内容区 */
        .main-wrapper {
            flex: 1;
            padding: 40px;
            overflow-y: auto;
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .page-title {
            font-size: 28px;
            font-weight: 700;
            margin: 0;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #e0e5f2;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: var(--primary-color);
            overflow: hidden;
        }
        
        .avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        /* 卡片容器 */
        .card {
            background: white;
            border-radius: 20px;
            padding: 25px;
            box-shadow: var(--card-shadow);
            margin-bottom: 25px;
        }

        /* 功能菜单 */
        .feature-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .feature-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: var(--card-shadow);
            text-align: center;
            transition: transform 0.3s;
            cursor: pointer;
        }

        .feature-card:hover {
            transform: translateY(-5px);
        }

        .feature-icon {
            font-size: 36px;
            color: var(--primary-color);
            margin-bottom: 15px;
        }

        .feature-title {
            font-weight: 600;
            margin-bottom: 10px;
        }

        .feature-desc {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .logout-btn {
            margin-top: auto;
            color: #ff5b5b;
        }
        
        /* 我的信息样式 */
        .profile-info {
            text-align: center;
        }
        
        .info-group {
            display: flex;
            justify-content: space-between;
            max-width: 400px;
            margin: 15px auto;
            padding: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .info-group label {
            font-weight: bold;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }
        
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #e0e5f2;
            border-radius: 12px;
            background: #f4f7fe;
            outline: none;
            box-sizing: border-box;
        }
        
        /* 搜索框样式 */
        .search-container {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .search-box {
            flex: 1;
        }
        
        .search-box input {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #e0e5f2;
            border-radius: 12px;
            background: #f4f7fe;
            outline: none;
            box-sizing: border-box;
        }

        /* 隐藏内容区域 */
        .content-section {
            display: none;
        }

        .content-section.active {
            display: block;
        }
        
        /* 按钮样式 */
        .btn-select {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 500;
            transition: background 0.3s;
        }
        .btn-select:hover {
            opacity: 0.9;
        }
        .btn-danger {
            background-color: #ff5b5b;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
        }
        .btn-outline {
            background-color: transparent;
            border: 1px solid var(--primary-color);
            color: var(--primary-color);
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <div class="logo">
            <i class="fas fa-shield-halved"></i> TQMS
        </div>
        <button class="menu-item active" data-target="dashboard">
            <i class="fas fa-home"></i> 首页
        </button>
        <button class="menu-item" data-target="profile">
            <i class="fas fa-user"></i> 我的信息
        </button>
        <button class="menu-item" data-target="courses">
            <i class="fas fa-book-open"></i> 课程管理
        </button>
        <!-- 修正：分离学生、教师、管理员管理 -->
        <button class="menu-item" data-target="students">
            <i class="fas fa-user-graduate"></i> 学生管理
        </button>
        <button class="menu-item" data-target="teachers">
            <i class="fas fa-chalkboard-teacher"></i> 教师管理
        </button>
        <button class="menu-item" data-target="send-message">
            <i class="fas fa-paper-plane"></i> 发送消息
        </button>
        <button class="menu-item" data-target="messages">
            <i class="fas fa-envelope"></i> 我的消息
        </button>
        <button class="menu-item" data-target="system-info">
            <i class="fas fa-info-circle"></i> 系统信息
        </button>
        
        <button class="menu-item logout-btn" onclick="logout()">
            <i class="fas fa-sign-out-alt"></i> 退出登录
        </button>
    </div>

    <div class="main-wrapper">
        <div class="header-top">
            <h1 class="page-title">管理员主页</h1>
            <div class="user-info">
                <span id="user-role">管理员</span>
                <div class="avatar" id="user-avatar">A</div>
            </div>
        </div>

        <!-- 首页内容 -->
        <div id="dashboard" class="content-section active">
            <div class="card">
                <h2>欢迎使用课程管理系统</h2>
                <p>您好，管理员！在这里您可以管理系统的所有信息。</p>
                
                <div class="feature-grid">
                    <div class="feature-card" data-target="profile">
                        <div class="feature-icon"><i class="fas fa-user"></i></div>
                        <div class="feature-title">我的信息</div>
                        <div class="feature-desc">查看和修改个人信息</div>
                    </div>
                    <div class="feature-card" data-target="courses">
                        <div class="feature-icon"><i class="fas fa-book-open"></i></div>
                        <div class="feature-title">课程管理</div>
                        <div class="feature-desc">管理所有课程信息</div>
                    </div>
                    <div class="feature-card" data-target="students">
                        <div class="feature-icon"><i class="fas fa-user-graduate"></i></div>
                        <div class="feature-title">学生管理</div>
                        <div class="feature-desc">管理学生账户</div>
                        </div>
                    <div class="feature-card" data-target="teachers">
                        <div class="feature-icon"><i class="fas fa-chalkboard-teacher"></i></div>
                        <div class="feature-title">教师管理</div>
                        <div class="feature-desc">管理教师账户</div>
                        </div>
                    <div class="feature-card" data-target="send-message">
                        <div class="feature-icon"><i class="fas fa-paper-plane"></i></div>
                        <div class="feature-title">发送消息</div>
                        <div class="feature-desc">发送消息给用户</div>
                    </div>
                    <div class="feature-card" data-target="messages">
                        <div class="feature-icon"><i class="fas fa-envelope"></i></div>
                        <div class="feature-title">我的消息</div>
                        <div class="feature-desc">查看系统消息</div>
                    </div>
                    <div class="feature-card" data-target="system-info">
                        <div class="feature-icon"><i class="fas fa-info-circle"></i></div>
                        <div class="feature-title">系统信息</div>
                        <div class="feature-desc">查看系统统计信息</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 我的信息 -->
        <div id="profile" class="content-section">
            <div class="card">
                <h2>我的信息</h2>
                <div class="profile-info">
                    <div class="avatar-large" id="profile-avatar" style="width: 100px; height: 100px; border-radius: 50%; background: #e0e5f2; display: flex; align-items: center; justify-content: center; font-size: 36px; font-weight: bold; color: var(--primary-color); margin: 0 auto 20px;"></div>
                    <div class="info-group">
                        <label>ID:</label>
                        <span id="profile-id"></span>
                    </div>
                    <div class="info-group">
                        <label>用户名:</label>
                        <span id="profile-username"></span>
                    </div>
                    <div class="info-group">
                        <label>真实姓名:</label>
                        <span id="profile-realname"></span>
                    </div>
                </div>
            </div>
        </div>

        <!-- 课程管理 -->
        <div id="courses" class="content-section">
            <div class="card">
                <h2>课程管理</h2>
                <div class="search-container">
                    <div class="search-box">
                        <input type="text" id="course-search" placeholder="搜索课程...">
                    </div>
                    <button class="btn-select" onclick="searchCourses()">搜索</button>
                </div>
                <div id="courses-list"><p>加载中...</p></div>
            </div>
        </div>

        <!-- 学生管理 (新增，修正原代码缺失) -->
        <div id="students" class="content-section">
            <div class="card">
                <h2>学生管理</h2>
                <div class="search-container">
                    <div class="search-box"><input type="text" id="student-search" placeholder="搜索学生..."></div>
                    <button class="btn-select" onclick="searchStudents()">搜索</button>
                    </div>
                <div id="students-list"><p>加载中...</p></div>
                </div>
                </div>
                
        <!-- 教师管理 (新增，修正原代码缺失) -->
        <div id="teachers" class="content-section">
            <div class="card">
                <h2>教师管理</h2>
                <div class="search-container">
                    <div class="search-box"><input type="text" id="teacher-search" placeholder="搜索教师..."></div>
                    <button class="btn-select" onclick="searchTeachers()">搜索</button>
                </div>
                <div id="teachers-list"><p>加载中...</p></div>
            </div>
        </div>

        <!-- 系统信息 -->
        <div id="system-info" class="content-section">
            <div class="card">
                <h2>系统统计</h2>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 20px;">
                        <div style="padding: 20px; background: #f0f7ff; border-radius: 12px; text-align: center;">
                            <div style="font-size: 24px; font-weight: bold; color: #5c4cf4;" id="total-students">0</div>
                            <div style="color: #a3aed0; margin-top: 5px;">学生总数</div>
                        </div>
                        <div style="padding: 20px; background: #f0f7ff; border-radius: 12px; text-align: center;">
                            <div style="font-size: 24px; font-weight: bold; color: #5c4cf4;" id="total-teachers">0</div>
                            <div style="color: #a3aed0; margin-top: 5px;">教师总数</div>
                        </div>
                        <div style="padding: 20px; background: #f0f7ff; border-radius: 12px; text-align: center;">
                            <div style="font-size: 24px; font-weight: bold; color: #5c4cf4;" id="total-courses">0</div>
                            <div style="color: #a3aed0; margin-top: 5px;">课程总数</div>
                        </div>
                        <div style="padding: 20px; background: #f0f7ff; border-radius: 12px; text-align: center;">
                            <div style="font-size: 24px; font-weight: bold; color: #5c4cf4;" id="total-admins">0</div>
                            <div style="color: #a3aed0; margin-top: 5px;">管理员总数</div>
                        </div>
                    </div>
                </div>
                    </div>
        
        <!-- 发送消息 -->
        <div id="send-message" class="content-section">
            <div class="card">
                <h2>发送消息</h2>
                <div class="form-group">
                    <label>发送范围</label>
                    <select id="message-type">
                        <option value="all">所有用户</option>
                        <option value="teachers">所有教师</option>
                        <option value="students">所有学生</option>
                    </select>
                </div>
                <div class="form-group"><label>标题</label><input type="text" id="message-title"></div>
                <div class="form-group"><label>内容</label><textarea id="message-content" rows="4"></textarea></div>
                <button class="btn-select" onclick="sendMessage()">发送消息</button>
                <div id="send-message-result" style="margin-top: 15px;"></div>
            </div>
        </div>
        
        <!-- 我的消息 -->
        <div id="messages" class="content-section">
            <div class="card">
                <h2>我的消息</h2>
                <div class="search-container">
                    <div class="search-box"><input type="text" id="message-search" placeholder="搜索消息..."></div>
                    <button class="btn-select" onclick="searchMessages()">搜索</button>
                </div>
                <div id="messages-list"><p>加载中...</p></div>
                </div>
                </div>
                </div>

                <script>
        // 通用 API 请求函数
        function apiRequest(url, options = {}) {
            const currentUser = JSON.parse(sessionStorage.getItem('currentUser'));
            const defaultHeaders = { 'Content-Type': 'application/json' };
            if (currentUser) {
                defaultHeaders['X-User-Id'] = currentUser.id;
                defaultHeaders['X-User-Role'] = currentUser.role;
            }
            const requestOptions = { ...options, headers: { ...defaultHeaders, ...(options.headers || {}) } };
            return fetch(url, requestOptions).then(response => {
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                return response.json();
            });
        }

        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            updateUserInfoDisplay();
            loadAllData();
            setupNavigation();
            
            // 检查URL hash，自动显示对应的section
            const hash = window.location.hash.replace('#', '');
            if (hash) {
                // 如果hash匹配一个有效的section，显示它
                const validSections = ['dashboard', 'profile', 'courses', 'students', 'teachers', 'messages', 'system-info'];
                if (validSections.includes(hash)) {
                    const handleNav = (target) => {
                        document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
                        document.querySelectorAll('.menu-item').forEach(i => i.classList.remove('active'));
                        
                        const section = document.getElementById(target);
                        if (section) section.classList.add('active');
                        
                        const menu = document.querySelector(`.menu-item[data-target="${target}"]`);
                        if (menu) menu.classList.add('active');
                        
                        // 刷新对应数据
                        if (target === 'courses') loadCourses();
                        if (target === 'students') loadStudents();
                        if (target === 'teachers') loadTeachers();
                        if (target === 'system-info') loadSystemStats();
                        if (target === 'messages') loadMessages();
                        
                        // 退出登录按钮始终显示在主页（所有section都显示）
                        const logoutBtn = document.querySelector('.logout-btn');
                        if (logoutBtn) {
                            logoutBtn.style.display = 'flex';
                        }
                    };
                    handleNav(hash);
                }
            }
            
            // 监听页面重新获得焦点时更新用户信息和列表
            window.addEventListener('focus', function() {
                updateUserInfoDisplay();
                // 根据当前激活板块自动刷新对应数据，确保“页面获得焦点时刷新”
                const activeSection = document.querySelector('.content-section.active');
                if (!activeSection) return;
                const sectionId = activeSection.id;
                if (sectionId === 'students') {
                    loadStudents();
                } else if (sectionId === 'teachers') {
                    loadTeachers();
                } else if (sectionId === 'messages') {
                    loadMessages();
                } else if (sectionId === 'courses') {
                    loadCourses();
                } else if (sectionId === 'system-info') {
                    loadSystemStats();
                }
            });
            
            // 初始化退出登录按钮显示（默认显示，因为首页是dashboard）
            const logoutBtn = document.querySelector('.logout-btn');
            if (logoutBtn) {
                logoutBtn.style.display = 'flex';
            }
        });

        function loadAllData() {
            loadCourses();
            loadStudents();
            loadTeachers();
            loadSystemStats();
            loadMessages();
        }

        function setupNavigation() {
            const handleNav = (target) => {
                document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
                document.querySelectorAll('.menu-item').forEach(i => i.classList.remove('active'));
                
                const section = document.getElementById(target);
                if (section) section.classList.add('active');
                
                const menu = document.querySelector(`.menu-item[data-target="${target}"]`);
                if (menu) menu.classList.add('active');
                
                // 刷新对应数据
                if (target === 'courses') loadCourses();
                if (target === 'students') loadStudents();
                if (target === 'teachers') loadTeachers();
                if (target === 'system-info') loadSystemStats();
                if (target === 'messages') loadMessages();
                
                // 退出登录按钮始终显示在主页（所有section都显示）
                const logoutBtn = document.querySelector('.logout-btn');
                if (logoutBtn) {
                    logoutBtn.style.display = 'flex';
                }
            };

            document.querySelectorAll('[data-target]').forEach(el => {
                el.addEventListener('click', () => handleNav(el.getAttribute('data-target')));
            });
        }

        function updateUserInfoDisplay() {
            const currentUser = JSON.parse(sessionStorage.getItem('currentUser'));
            if (currentUser) {
                document.getElementById('user-role').textContent = '管理员: ' + currentUser.realName;
                document.getElementById('user-avatar').textContent = currentUser.realName.charAt(0);
                document.getElementById('profile-avatar').textContent = currentUser.realName.charAt(0);
                document.getElementById('profile-id').textContent = currentUser.id;
                document.getElementById('profile-username').textContent = currentUser.username;
                document.getElementById('profile-realname').textContent = currentUser.realName;
            }
        }
        
        // --- 课程管理 ---
        function loadCourses() {
            apiRequest('/api/courses').then(data => {
                if (data.code === 200) displayCourses(data.data);
            }).catch(e => console.error(e));
        }

        function displayCourses(courses) {
            const list = document.getElementById('courses-list');
            if (!courses || courses.length === 0) { list.innerHTML = '<p>暂无课程</p>'; return; }
            let html = `<table style="width:100%;border-collapse:collapse;"><thead><tr style="background:#f4f7fe;text-align:left;"><th style="padding:12px;">编号</th><th>名称</th><th>学分</th><th>教师</th><th>选课人数</th><th>操作</th></tr></thead><tbody>`;
            courses.forEach(c => {
                html += `<tr><td style="padding:12px;border-bottom:1px solid #e0e5f2;">${c.courseCode}</td>
                        <td style="padding:12px;border-bottom:1px solid #e0e5f2;">${c.courseName}</td>
                        <td style="padding:12px;border-bottom:1px solid #e0e5f2;">${c.credits}</td>
                        <td style="padding:12px;border-bottom:1px solid #e0e5f2;">${c.teacherName || '-'}</td>
                        <td style="padding:12px;border-bottom:1px solid #e0e5f2;">${c.studentCount || 0}</td>
                        <td style="padding:12px;border-bottom:1px solid #e0e5f2;"><button class="btn-danger" onclick="deleteCourse(${c.id})">删除</button></td></tr>`;
            });
            list.innerHTML = html + '</tbody></table>';
        }

        function deleteCourse(id) {
            if(confirm("确定删除？")) apiRequest(`/api/courses/${id}`, { method: 'DELETE' }).then(() => loadCourses());
        }

        // --- 用户管理通用逻辑 (学生/教师/管理员) ---
        function loadUsersGeneric(rolePath, containerId, displayFunc) {
            apiRequest(`/api/users/${rolePath}`).then(res => {
                if(res.code === 200) displayFunc(res.data);
                else document.getElementById(containerId).innerHTML = `<p>${res.msg}</p>`;
            }).catch(() => document.getElementById(containerId).innerHTML = '<p>加载失败</p>');
        }

        function loadStudents() { loadUsersGeneric('students', 'students-list', (data) => displayUserTable(data, 'students-list', 'student')); }
        function loadTeachers() { loadUsersGeneric('teachers', 'teachers-list', (data) => displayUserTable(data, 'teachers-list', 'teacher')); }

        function displayUserTable(users, containerId, type) {
            const list = document.getElementById(containerId);
            if (!users || users.length === 0) { list.innerHTML = '<p>暂无数据</p>'; return; }
            let html = `<table style="width:100%;border-collapse:collapse;"><thead><tr style="background:#f4f7fe;text-align:left;"><th style="padding:12px;">用户名</th><th>姓名</th><th>注册时间</th><th>操作</th></tr></thead><tbody>`;
            users.forEach(u => {
                const safeId = (u.id || '').toString().replace(/'/g, "\\'");
                html += `<tr>
                    <td style="padding:12px;border-bottom:1px solid #e0e5f2;">${u.username}</td>
                    <td style="padding:12px;border-bottom:1px solid #e0e5f2;">${u.realName}</td>
                    <td style="padding:12px;border-bottom:1px solid #e0e5f2;">${u.createTime ? new Date(u.createTime).toLocaleDateString() : '-'}</td>
                    <td style="padding:12px;border-bottom:1px solid #e0e5f2;">
                        <button class="btn-outline" onclick="resetPassword('${safeId}')">重置密码</button>
                        <button class="btn-danger" onclick="deleteUser('${safeId}', '${type}')">删除</button>
                    </td></tr>`;
            });
            list.innerHTML = html + '</tbody></table>';
        }

        function addUser(role, prefix) {
            const data = {
                username: document.getElementById(`${prefix}-username`).value,
                password: document.getElementById(`${prefix}-password`).value,
                realName: document.getElementById(`${prefix}-realname`).value,
                role: role
            };
            if(!data.username || !data.password) return alert("请填写完整");
            apiRequest('/api/users', { method: 'POST', body: JSON.stringify(data) }).then(res => {
                if(res.code === 200) { 
                    alert('添加成功'); 
                    if(role===3) loadStudents();
                } else alert(res.msg);
            });
        }

        function addStudent() { addUser(3, 'student'); }

        function deleteUser(id, type) {
            if(confirm("确定删除用户？")) {
                apiRequest(`/api/users/${id}`, { method: 'DELETE' }).then(() => {
                    if(type==='student') loadStudents();
                    if(type==='teacher') loadTeachers();
                    if(type==='admin') loadAdmins && loadAdmins();
                });
            }
        }

        function resetPassword(id) {
            if(confirm("重置密码为 123456？")) {
                apiRequest(`/api/users/${id}/reset-password`, { 
                    method: 'PUT', 
                    body: JSON.stringify({ password: '123456' }) 
                }).then(res => {
                    alert(res.code === 200 ? "成功" : res.msg);
                });
            }
        }

        // --- 消息 & 系统信息 ---
        function loadSystemStats() {
            Promise.all([
                fetch('/api/users/students/count'),
                fetch('/api/users/teachers/count'),
                fetch('/api/courses/count'),
                fetch('/api/users/admins/count')
            ]).then(async ([r1, r2, r3, r4]) => {
                document.getElementById('total-students').textContent = (await r1.json()).data || 0;
                document.getElementById('total-teachers').textContent = (await r2.json()).data || 0;
                document.getElementById('total-courses').textContent = (await r3.json()).data || 0;
                document.getElementById('total-admins').textContent = (await r4.json()).data || 0;
            });
        }

        function loadMessages() {
            const user = JSON.parse(sessionStorage.getItem('currentUser'));
            if(!user) return;
            apiRequest(`/api/messages/user/${user.id}`).then(res => {
                const list = document.getElementById('messages-list');
                if(!res.data || res.data.length===0) { list.innerHTML='<p>无消息</p>'; return; }
                let html = `
                    <div style="margin-bottom: 15px;">
                        <button class="btn-danger" onclick="batchDeleteMessages()" style="background:#ff5b5b; color:white; border:none; padding:8px 15px; border-radius:8px; cursor:pointer;">
                            <i class="fas fa-trash"></i> 批量删除
                        </button>
                    </div>
                    <table style="width:100%;border-collapse:collapse;">
                        <thead>
                            <tr style="background:#f4f7fe;text-align:left;">
                                <th style="padding:12px;"><input type="checkbox" id="select-all" onclick="toggleSelectAll()"></th>
                                <th style="padding:12px;">标题</th>
                                <th style="padding:12px;">时间</th>
                                <th style="padding:12px;">操作</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                res.data.forEach(m => {
                    const safeTitle = (m.title || '').replace(/'/g, "\\'").replace(/"/g, '&quot;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
                    html += `<tr>
                        <td style="padding:12px;border-bottom:1px solid #e0e5f2;"><input type="checkbox" class="message-checkbox" data-id="${m.id}"></td>
                        <td style="padding:12px;border-bottom:1px solid #e0e5f2;">${m.title || ''}</td>
                        <td style="padding:12px;border-bottom:1px solid #e0e5f2;">${new Date(m.createTime).toLocaleString()}</td>
                        <td style="padding:12px;border-bottom:1px solid #e0e5f2;"><button class="btn-select" onclick="viewMessageDetail(${m.id}, '${safeTitle}')">查看详情</button></td>
                    </tr>`;
                });
                list.innerHTML = html + '</tbody></table>';
            });
        }
        
        // 全选/取消全选
        function toggleSelectAll() {
            const selectAllCheckbox = document.getElementById('select-all');
            if (!selectAllCheckbox) return;
            const checkboxes = document.querySelectorAll('.message-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAllCheckbox.checked;
            });
        }
        
        // 批量删除消息
        function batchDeleteMessages() {
            const selectedCheckboxes = document.querySelectorAll('.message-checkbox:checked');
            
            if (selectedCheckboxes.length === 0) {
                alert('请至少选择一条消息');
                return;
            }
            
            if (!confirm(`确定要删除选中的 ${selectedCheckboxes.length} 条消息吗？此操作不可恢复！`)) {
                return;
            }
            
            // 获取选中的消息ID
            const messageIds = Array.from(selectedCheckboxes).map(checkbox => 
                parseInt(checkbox.getAttribute('data-id'))
            );
            
            // 发送批量删除请求
            fetch('/api/messages/batch', {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(messageIds)
            })
            .then(response => response.json())
            .then(data => {
                if (data.code === 200) {
                    alert(`成功删除 ${selectedCheckboxes.length} 条消息！`);
                    // 重新加载消息列表
                    loadMessages();
                } else {
                    alert('删除失败: ' + (data.msg || '未知错误'));
                }
            })
            .catch(error => {
                console.error('批量删除消息失败:', error);
                alert('删除失败，请稍后重试');
            });
        }
        
        function viewMessageDetail(messageId, messageTitle) {
            window.location.href = `message-detail.html?id=${messageId}`;
        }

        function sendMessage() {
            const type = document.getElementById('message-type').value;
            const title = document.getElementById('message-title').value;
            const content = document.getElementById('message-content').value;
            const resultElement = document.getElementById('send-message-result');
            
            // 验证输入
            if (!title || !content) {
                resultElement.innerHTML = '<p style="color: #ff5b5b;">请填写标题和内容</p>';
                return;
            }
            
            const currentUser = JSON.parse(sessionStorage.getItem('currentUser'));
            if (!currentUser) {
                resultElement.innerHTML = '<p style="color: #ff5b5b;">请先登录</p>';
                return;
            }
            
            const data = {
                title: title,
                content: content,
                sender: currentUser.realName,
                type: type
            };
            
            apiRequest('/api/messages/send', { method: 'POST', body: JSON.stringify(data) }).then(res => {
                if(res.code===200) {
                    resultElement.innerHTML = '<p style="color: green;">消息发送成功！</p>';
                    document.getElementById('message-title').value = '';
                    document.getElementById('message-content').value = '';
                    // 5秒后清除提示
                    setTimeout(() => {
                        resultElement.innerHTML = '';
                    }, 5000);
                    loadMessages();
                } else {
                    resultElement.innerHTML = '<p style="color: #ff5b5b;">发送失败: ' + res.msg + '</p>';
                }
            }).catch(error => {
                console.error('发送消息失败:', error);
                resultElement.innerHTML = '<p style="color: #ff5b5b;">发送消息失败，请稍后重试</p>';
            });
        }

        function logout() {
            sessionStorage.removeItem('currentUser');
            window.location.href = 'login.html';
        }
    </script>
</body>
</html>

