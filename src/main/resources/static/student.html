


<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>课程管理系统 - 学生主页</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #5c4cf4;
            --bg-color: #f4f7fe;
            --sidebar-bg: #ffffff;
            --text-main: #2b3674;
            --text-secondary: #a3aed0;
            --card-shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
        }

        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            background-color: var(--bg-color);
            color: var(--text-main);
            display: flex;
            min-height: 100vh;
        }

        /* 侧边栏 */
        .sidebar {
            width: 260px;
            background: var(--sidebar-bg);
            border-right: 1px solid #e0e5f2;
            padding: 30px 20px;
            display: flex;
            flex-direction: column;
        }

        .logo {
            font-size: 24px;
            font-weight: bold;
            color: var(--primary-color);
            margin-bottom: 40px;
            padding-left: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .menu-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            text-decoration: none;
            color: var(--text-secondary);
            border-radius: 12px;
            margin-bottom: 8px;
            transition: all 0.3s;
            border: none;
            background: none;
            width: 100%;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            text-align: left; /* 确保文字左对齐 */
        }

        .menu-item:hover, .menu-item.active {
            background-color: #f7f8fe;
            color: var(--primary-color);
        }

        .menu-item.active {
            border-right: 4px solid var(--primary-color);
            border-radius: 12px 0 0 12px;
        }

        /* 主内容区 */
        .main-wrapper {
            flex: 1;
            padding: 40px;
            overflow-y: auto;
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .page-title {
            font-size: 28px;
            font-weight: 700;
            margin: 0;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #e0e5f2;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: var(--primary-color);
            overflow: hidden;
        }
        
        .avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        /* 卡片容器 */
        .card {
            background: white;
            border-radius: 20px;
            padding: 25px;
            box-shadow: var(--card-shadow);
            margin-bottom: 25px;
        }

        /* 功能菜单 */
        .feature-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .feature-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: var(--card-shadow);
            text-align: center;
            transition: transform 0.3s;
            cursor: pointer;
        }

        .feature-card:hover {
            transform: translateY(-5px);
        }

        .feature-icon {
            font-size: 36px;
            color: var(--primary-color);
            margin-bottom: 15px;
        }

        .feature-title {
            font-weight: 600;
            margin-bottom: 10px;
        }

        .feature-desc {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .logout-btn {
            margin-top: auto;
            color: #ff5b5b;
            display: flex;
        }
        
        /* 我的信息样式 */
        .profile-info {
            text-align: center;
        }
        
        .info-group {
            display: flex;
            justify-content: space-between;
            max-width: 400px;
            margin: 15px auto;
            padding: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .info-group label {
            font-weight: bold;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }
        
        .form-group input {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #e0e5f2;
            border-radius: 12px;
            background: #f4f7fe;
            outline: none;
            box-sizing: border-box;
        }

        /* 隐藏内容区域 */
        .content-section {
            display: none;
        }

        .content-section.active {
            display: block;
        }
        
        /* 按钮样式 */
        .btn-select {
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 12px;
            padding: 10px 20px;
            cursor: pointer;
            font-weight: 500;
            transition: background-color 0.3s;
        }
        
        .btn-select:hover {
            background-color: #4a3ce0;
        }
        
        .btn-outline {
            background-color: transparent;
            color: var(--primary-color);
            border: 1px solid var(--primary-color);
            border-radius: 12px;
            padding: 6px 12px; /* 调整为更小的尺寸 */
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
            font-size: 14px; /* 调整字体大小 */
        }
        
        .btn-outline:hover {
            background-color: var(--primary-color);
            color: white;
        }
        
        .btn-danger {
            background-color: #ff5b5b;
            color: white;
            border: none;
            border-radius: 12px;
            padding: 6px 12px;
            cursor: pointer;
            font-weight: 500;
            transition: background-color 0.3s;
            font-size: 14px;
        }
        
        .btn-danger:hover {
            background-color: #ff3b3b;
        }
        
        .btn-selected {
            background-color: #6c757d;
            color: white;
            border: none;
            border-radius: 12px;
            padding: 6px 12px;
            cursor: pointer;
            font-weight: 500;
            transition: background-color 0.3s;
            font-size: 14px;
        }
        
        .btn-selected:hover {
            background-color: #5a6268;
        }
        
        /* 搜索框样式 */
        .search-container {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .search-box {
            flex: 1;
        }
        
        .search-box input {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #e0e5f2;
            border-radius: 12px;
            background: #f4f7fe;
            outline: none;
            box-sizing: border-box;
        }
        
        /* 表格样式 */
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e0e5f2;
        }
        
        th {
            background-color: #f4f7fe;
            font-weight: 600;
        }
        
        tr:hover {
            background-color: #f8f9fa;
        }
        
        /* 选课页面样式 */
        #course-selection {
            display: none;
        }
        
        #course-selection.active {
            display: block;
        }
        
        /* 无数据提示 */
        .no-data {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-secondary);
        }
        
        .no-data i {
            font-size: 48px;
            margin-bottom: 15px;
            opacity: 0.5;
        }
        
        /* 消息列表样式 */
        .message-actions {
            margin-bottom: 15px;
        }
        
        .message-checkbox-cell {
            width: 30px;
            text-align: center;
        }
        
        .message-status {
            padding: 4px 8px;
            border-radius: 4px;
        }
        
        .message-operation {
            padding: 6px 12px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <div class="logo">
            <i class="fas fa-user-graduate"></i> TQMS
        </div>
        <button class="menu-item active" data-target="dashboard">
            <i class="fas fa-home"></i> 首页
        </button>
        <button class="menu-item" data-target="profile">
            <i class="fas fa-user"></i> 我的信息
        </button>
        <button class="menu-item" data-target="courses">
            <i class="fas fa-book-open"></i> 我的课程
        </button>
        <button class="menu-item" data-target="assignments">
            <i class="fas fa-file-alt"></i> 我的作业
        </button>
        <button class="menu-item" data-target="messages">
            <i class="fas fa-envelope"></i> 我的消息
        </button>
        <button class="menu-item" data-target="send-message">
            <i class="fas fa-paper-plane"></i> 发送消息
        </button>
        
        <button class="menu-item logout-btn" onclick="logout()">
            <i class="fas fa-sign-out-alt"></i> 退出登录
        </button>
    </div>

    <div class="main-wrapper">
        <div class="header-top">
            <h1 class="page-title">学生主页</h1>
            <div class="user-info">
                <span id="user-role">学生</span>
                <div class="avatar" id="user-avatar">S</div>
            </div>
        </div>

        <!-- 首页内容 -->
        <div id="dashboard" class="content-section active">
            <div class="card">
                <h2>欢迎使用课程管理系统</h2>
                <p>您好，同学！在这里您可以管理您的课程、作业等信息。</p>
                
                <div class="feature-grid">
                    <div class="feature-card" data-target="profile">
                        <div class="feature-icon">
                            <i class="fas fa-user"></i>
                        </div>
                        <div class="feature-title">我的信息</div>
                        <div class="feature-desc">查看和修改个人信息</div>
                    </div>
                    
                    <div class="feature-card" data-target="courses">
                        <div class="feature-icon">
                            <i class="fas fa-book-open"></i>
                        </div>
                        <div class="feature-title">我的课程</div>
                        <div class="feature-desc">查看已选修的课程</div>
                    </div>
                    
                    <div class="feature-card" data-target="assignments">
                        <div class="feature-icon">
                            <i class="fas fa-file-alt"></i>
                        </div>
                        <div class="feature-title">我的作业</div>
                        <div class="feature-desc">查看需要完成的作业</div>
                    </div>
                    
                    <div class="feature-card" data-target="messages">
                        <div class="feature-icon">
                            <i class="fas fa-envelope"></i>
                        </div>
                        <div class="feature-title">我的消息</div>
                        <div class="feature-desc">查看系统消息</div>
                    </div>
                    
                    <div class="feature-card" data-target="send-message">
                        <div class="feature-icon">
                            <i class="fas fa-paper-plane"></i>
                        </div>
                        <div class="feature-title">发送消息</div>
                        <div class="feature-desc">向管理员或教师发送消息</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 我的信息内容 -->
        <div id="profile" class="content-section">
            <div class="card">
                <h2>我的信息</h2>
                <div class="profile-info">
                    <div class="avatar-large" id="profile-avatar" style="width: 100px; height: 100px; border-radius: 50%; background: #e0e5f2; display: flex; align-items: center; justify-content: center; font-size: 36px; font-weight: bold; color: var(--primary-color); margin: 0 auto 20px;"></div>
                    <div class="info-group">
                        <label>ID:</label>
                        <span id="profile-id"></span>
                    </div>
                    <div class="info-group">
                        <label>用户名:</label>
                        <span id="profile-username"></span>
                    </div>
                    <div class="info-group">
                        <label>真实姓名:</label>
                        <span id="profile-realname"></span>
                    </div>
                    <div class="info-group">
                        <label>角色:</label>
                        <span>学生</span>
                    </div>
                </div>
                
                <div style="text-align: center; margin-top: 30px;">
                    <button class="btn-select" onclick="window.location.href='profile-edit.html'" style="margin: 0 10px;">修改个人信息</button>
                    <button class="btn-select" onclick="window.location.href='password-change.html'" style="margin: 0 10px;">修改密码</button>
                </div>
            </div>
        </div>

        <!-- 我的课程内容 -->
        <div id="courses" class="content-section">
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>我的课程</h2>
                    <button class="btn-select" onclick="showCourseSelection()" style="padding: 8px 16px;">选课</button>
                </div>
                <div class="search-container">
                    <div class="search-box">
                        <input type="text" id="course-search" placeholder="搜索课程...">
                    </div>
                    <button class="btn-select" onclick="searchEnrolledCourses()">搜索</button>
                </div>
                <div id="courses-list">
                    <p>加载中...</p>
                </div>
            </div>
        </div>
        
        <!-- 选课页面 -->
        <div id="course-selection" class="content-section">
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>选课</h2>
                    <button class="btn-outline" onclick="showEnrolledCourses()" style="padding: 8px 16px;">
                        <i class="fas fa-arrow-left"></i> 返回我的课程
                    </button>
                </div>
                <div class="search-container">
                    <div class="search-box">
                        <input type="text" id="teacher-search" placeholder="输入教师名称...">
                    </div>
                    <div class="search-box">
                        <input type="text" id="course-name-search" placeholder="输入课程名称...">
                    </div>
                    <button class="btn-select" onclick="searchAvailableCourses()">搜索</button>
                </div>
                <div id="available-courses-list">
                    <p>加载中...</p>
                </div>
            </div>
        </div>

        <!-- 我的作业内容 -->
        <div id="assignments" class="content-section">
            <div class="card">
                <h2>我的作业</h2>
                <div class="search-container">
                    <div class="search-box">
                        <input type="text" id="assignment-search" placeholder="搜索作业...">
                    </div>
                    <button class="btn-select" onclick="searchAssignments()">搜索</button>
                </div>
                <div id="assignments-list">
                    <p>加载中...</p>
                </div>
            </div>
        </div>

        <!-- 作业提交内容 -->
        <div id="submissions" class="content-section">
            <div class="card">
                <h2>作业提交</h2>
                <div class="search-container">
                    <div class="search-box">
                        <input type="text" id="submission-search" placeholder="搜索已提交作业...">
                    </div>
                    <button class="btn-select" onclick="searchSubmissions()">搜索</button>
                </div>
                <div id="submissions-list">
                    <p>加载中...</p>
                </div>
                
                <hr style="margin: 30px 0;">
                
                <h3>提交新作业</h3>
                <div class="form-group">
                    <label for="assignment-id">作业ID</label>
                    <input type="number" id="assignment-id" placeholder="请输入作业ID">
                </div>
                <div class="form-group">
                    <label for="submission-content">提交内容</label>
                    <textarea id="submission-content" rows="5" placeholder="请输入作业内容" style="width: 100%; padding: 12px; border: 1px solid #e0e5f2; border-radius: 12px; background: #f4f7fe;"></textarea>
                </div>
                <div class="form-group">
                    <label for="submission-files">附件（可选，可多选）</label>
                    <input type="file" id="submission-files" multiple style="width: 100%; padding: 8px; border: 1px solid #e0e5f2; border-radius: 8px; background: #f4f7fe;">
                    <div id="file-list" style="margin-top: 10px; font-size: 14px; color: #666;"></div>
                </div>
                <button class="btn-select" onclick="submitAssignment()">提交作业</button>
                <div id="submission-result" style="margin-top: 15px;"></div>
            </div>
        </div>
        
        <!-- 我的消息内容 -->
        <div id="messages" class="content-section">
            <div class="card">
                <h2>我的消息</h2>
                <div class="search-container">
                    <div class="search-box">
                        <input type="text" id="message-search" placeholder="搜索消息...">
                    </div>
                    <button class="btn-select" onclick="searchMessages()">搜索</button>
                </div>
                <div id="messages-list">
                    <p>暂无消息</p>
                </div>
            </div>
        </div>
        
        <!-- 发送消息内容 -->
        <div id="send-message" class="content-section">
            <div class="card">
                <h2>发送消息</h2>
                
                <!-- 首先选择消息接收对象类型 -->
                <div class="form-group">
                    <label>发送对象</label>
                    <select id="message-target-type" onchange="onMessageTargetTypeChange()" style="width: 100%; padding: 12px; border: 1px solid #e0e5f2; border-radius: 12px; background: #f4f7fe;">
                        <option value="admin">管理员</option>
                        <option value="teacher">任课教师</option>
                    </select>
                </div>
                
                <!-- 发送给管理员 -->
                <div id="send-to-admin-block">
                    <div class="form-group">
                        <label for="admin-message-title">标题</label>
                        <input type="text" id="admin-message-title" placeholder="请输入消息标题">
                    </div>
                    <div class="form-group">
                        <label for="admin-message-content">内容</label>
                        <textarea id="admin-message-content" rows="4" placeholder="请输入消息内容" style="width: 100%; padding: 12px; border: 1px solid #e0e5f2; border-radius: 12px; background: #f4f7fe;"></textarea>
                    </div>
                    <button class="btn-select" onclick="sendMessageToAdmin()">发送消息给管理员</button>
                    <div id="admin-send-message-result" style="margin-top: 15px;"></div>
                </div>
                
                <!-- 发送给任课教师 -->
                <div id="send-to-teacher-block" style="display:none; margin-top: 15px;">
                    <div class="form-group">
                        <label for="teacher-course">选择课程</label>
                        <select id="teacher-course" style="width: 100%; padding: 12px; border: 1px solid #e0e5f2; border-radius: 12px; background: #f4f7fe;">
                            <option value="">请选择课程</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="teacher-message-title">标题</label>
                        <input type="text" id="teacher-message-title" placeholder="请输入消息标题">
                    </div>
                    <div class="form-group">
                        <label for="teacher-message-content">内容</label>
                        <textarea id="teacher-message-content" rows="4" placeholder="请输入消息内容" style="width: 100%; padding: 12px; border: 1px solid #e0e5f2; border-radius: 12px; background: #f4f7fe;"></textarea>
                    </div>
                    <button class="btn-select" onclick="sendMessageToTeacher()">发送消息给教师</button>
                    <div id="teacher-send-message-result" style="margin-top: 15px;"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 全局变量存储已选课程
        let enrolledCourseIds = [];
        
        // 页面加载完成后检查用户登录状态
        document.addEventListener('DOMContentLoaded', function() {
            updateUserInfoDisplay();
            
            // 加载课程和作业数据
            loadEnrolledCourses();
            loadAssignments();
            loadSubmissions();
            
            // 监听文件选择
            const fileInput = document.getElementById('submission-files');
            if (fileInput) {
                fileInput.addEventListener('change', updateFileList);
            }
            
            // 监听页面重新获得焦点时更新用户信息和当前板块数据
            window.addEventListener('focus', function() {
                updateUserInfoDisplay();
                const activeSection = document.querySelector('.content-section.active');
                if (!activeSection) return;
                const id = activeSection.id;
                if (id === 'courses') {
                    loadEnrolledCourses();
                } else if (id === 'course-selection') {
                    loadAvailableCourses();
                } else if (id === 'assignments') {
                    loadAssignments();
                } else if (id === 'submissions') {
                    loadSubmissions();
                } else if (id === 'messages') {
                    loadMessages();
                } else if (id === 'send-message') {
                    loadStudentCoursesForMessaging();
                }
            });
            
            console.log('学生主页已加载');
            
            // 初始化退出登录按钮显示（默认显示，因为首页是dashboard）
            const logoutBtn = document.querySelector('.logout-btn');
            if (logoutBtn) {
                logoutBtn.style.display = 'flex';
            }
            
            // 检查URL hash，自动显示对应的section
            const hash = window.location.hash.replace('#', '');
            if (hash) {
                // 如果hash匹配一个有效的section，显示它
                const validSections = ['dashboard', 'profile', 'courses', 'course-selection', 'assignments', 'submissions', 'messages', 'send-message'];
                if (validSections.includes(hash)) {
                    showSection(hash);
                    // 加载对应的数据
                    if (hash === 'courses') {
                        loadEnrolledCourses();
                    } else if (hash === 'course-selection') {
                        loadAvailableCourses();
                    } else if (hash === 'assignments') {
                        loadAssignments();
                    } else if (hash === 'submissions') {
                        loadSubmissions();
                    } else if (hash === 'messages') {
                        loadMessages();
                    } else if (hash === 'profile') {
                        updateUserInfoDisplay();
                    } else if (hash === 'send-message') {
                        loadStudentCoursesForMessaging();
                    }
                }
            }
            
            // 添加菜单点击事件
            document.querySelectorAll('.menu-item[data-target]').forEach(item => {
                item.addEventListener('click', function() {
                    const target = this.getAttribute('data-target');
                    showSection(target);
                    // 更新用户信息显示
                    if (target === 'profile') {
                        updateUserInfoDisplay();
                    }
                    // 当切换到课程页面时重新加载课程数据
                    if (target === 'courses') {
                        loadEnrolledCourses();
                    }
                    // 当切换到作业页面时重新加载作业数据（因为作业依赖于已选课程）
                    if (target === 'assignments') {
                        loadAssignments();
                    }
                    // 当切换到作业提交页面时加载提交数据
                    if (target === 'submissions') {
                        loadSubmissions();
                    }
                    // 当切换到消息页面时加载消息数据
                    if (target === 'messages') {
                        loadMessages();
                    }
                    // 当切换到发送消息页面时加载课程列表
                    if (target === 'send-message') {
                        loadStudentCoursesForMessaging();
                    }
                });
            });
            
            // 添加功能卡片点击事件
            document.querySelectorAll('.feature-card[data-target]').forEach(card => {
                card.addEventListener('click', function() {
                    const target = this.getAttribute('data-target');
                    showSection(target);
                    // 更新用户信息显示
                    if (target === 'profile') {
                        updateUserInfoDisplay();
                    }
                    // 当切换到课程页面时重新加载课程数据
                    if (target === 'courses') {
                        loadEnrolledCourses();
                    }
                    // 当切换到作业页面时重新加载作业数据（因为作业依赖于已选课程）
                    if (target === 'assignments') {
                        loadAssignments();
                    }
                    // 当切换到作业提交页面时加载提交数据
                    if (target === 'submissions') {
                        loadSubmissions();
                    }
                    // 当切换到发送消息页面时加载课程列表
                    if (target === 'send-message') {
                        loadStudentCoursesForMessaging();
                    }
                    // 当切换到作业提交页面时加载提交数据
                    if (target === 'submissions') {
                        loadSubmissions();
                    }
                });
            });
            
            // 在发送消息页面加载课程列表
            if (document.querySelector('#send-message.active')) {
                loadStudentCoursesForMessaging();
            }
        });
        
        // 更新用户信息显示
        function updateUserInfoDisplay() {
            const currentUser = JSON.parse(sessionStorage.getItem('currentUser'));
            if (currentUser) {
                // 显示用户信息
                document.getElementById('user-role').textContent = '学生: ' + currentUser.realName;
                
                // 显示头像
                updateAvatarDisplay('user-avatar', currentUser);
                
                // 在我的信息页面也显示用户信息
                updateAvatarDisplay('profile-avatar', currentUser);
                document.getElementById('profile-id').textContent = currentUser.id;
                document.getElementById('profile-username').textContent = currentUser.username;
                document.getElementById('profile-realname').textContent = currentUser.realName;
            }
        }
        
        // 更新头像显示的通用函数
        function updateAvatarDisplay(elementId, user) {
            const element = document.getElementById(elementId);
            if (user.avatar) {
                element.innerHTML = `<img src="${user.avatar}" alt="头像" style="width:100%;height:100%;object-fit:cover;border-radius:50%;">`;
            } else {
                element.textContent = user.realName.charAt(0);
            }
        }
        
        // 显示指定的内容区域
        function showSection(sectionId) {
            try {
                // 隐藏所有内容区域
                document.querySelectorAll('.content-section').forEach(section => {
                    section.classList.remove('active');
                });
                
                // 移除所有菜单项的激活状态
                document.querySelectorAll('.menu-item').forEach(item => {
                    item.classList.remove('active');
                });
                
                // 检查目标内容区域是否存在
                const targetSection = document.getElementById(sectionId);
                if (targetSection) {
                    // 显示目标内容区域
                    targetSection.classList.add('active');
                } else {
                    console.error(`内容区域 ${sectionId} 不存在`);
                    return; // 如果目标不存在，直接返回
                }
                
                // 激活对应的菜单项
                const targetMenuItem = document.querySelector(`.menu-item[data-target="${sectionId}"]`);
                if (targetMenuItem) {
                    targetMenuItem.classList.add('active');
                }
                
                // 更新页面标题
                const titles = {
                    'dashboard': '学生主页',
                    'profile': '我的信息',
                    'courses': '我的课程',
                    'assignments': '我的作业',
                    'submissions': '作业提交',
                    'messages': '我的消息'
                };
                
                const pageTitle = document.querySelector('.page-title');
                if (pageTitle) {
                    pageTitle.textContent = titles[sectionId] || '学生主页';
                }
                
                // 退出登录按钮始终显示在主页（所有section都显示）
                const logoutBtn = document.querySelector('.logout-btn');
                if (logoutBtn) {
                    logoutBtn.style.display = 'flex';
                }
            } catch (error) {
                console.error('切换页面时出错:', error);
            }
        }
        
        // 显示选课页面
        function showCourseSelection() {
            try {
                // 隐藏所有内容区域
                document.querySelectorAll('.content-section').forEach(section => {
                    section.classList.remove('active');
                });
                
                // 移除所有菜单项的激活状态
                document.querySelectorAll('.menu-item').forEach(item => {
                    item.classList.remove('active');
                });
                
                // 显示选课页面
                const courseSelectionSection = document.getElementById('course-selection');
                if (courseSelectionSection) {
                    courseSelectionSection.classList.add('active');
                }
                
                // 更新页面标题
                const pageTitle = document.querySelector('.page-title');
                if (pageTitle) {
                    pageTitle.textContent = '选课';
                }
                
                // 加载可选课程
                loadAvailableCourses();
            } catch (error) {
                console.error('显示选课页面时出错:', error);
            }
        }
        
        // 返回我的课程页面
        function showEnrolledCourses() {
            try {
                // 隐藏所有内容区域
                document.querySelectorAll('.content-section').forEach(section => {
                    section.classList.remove('active');
                });
                
                // 移除所有菜单项的激活状态
                document.querySelectorAll('.menu-item').forEach(item => {
                    item.classList.remove('active');
                });
                
                // 显示我的课程页面
                const coursesSection = document.getElementById('courses');
                if (coursesSection) {
                    coursesSection.classList.add('active');
                }
                
                // 激活对应的菜单项
                const coursesMenuItem = document.querySelector('.menu-item[data-target="courses"]');
                if (coursesMenuItem) {
                    coursesMenuItem.classList.add('active');
                }
                
                // 更新页面标题
                const pageTitle = document.querySelector('.page-title');
                if (pageTitle) {
                    pageTitle.textContent = '我的课程';
                }
                
                // 重新加载已选课程
                loadEnrolledCourses();
            } catch (error) {
                console.error('返回我的课程页面时出错:', error);
            }
        }
        
        // 修改密码功能
        function changePassword() {
            const currentPassword = document.getElementById('current-password').value;
            const newPassword = document.getElementById('new-password').value;
            const confirmPassword = document.getElementById('confirm-password').value;
            const resultElement = document.getElementById('password-result');
            
            if (!currentPassword || !newPassword || !confirmPassword) {
                resultElement.innerHTML = '<p style="color: #ff5b5b;">请填写所有密码字段</p>';
                return;
            }
            
            if (newPassword !== confirmPassword) {
                resultElement.innerHTML = '<p style="color: #ff5b5b;">新密码和确认密码不一致</p>';
                return;
            }
            
            // 这里应该是调用后端API修改密码
            resultElement.innerHTML = '<p style="color: green;">密码修改成功</p>';
            
            // 清空输入框
            document.getElementById('current-password').value = '';
            document.getElementById('new-password').value = '';
            document.getElementById('confirm-password').value = '';
        }
        
        // 加载已选课程数据
        function loadEnrolledCourses() {
            const currentUser = JSON.parse(sessionStorage.getItem('currentUser'));
            if (!currentUser) {
                document.getElementById('courses-list').innerHTML = '<p>请先登录</p>';
                return;
            }
            
            // 调用后端API获取学生已选课程
            fetch(`/api/student-courses/student/${currentUser.id}/courses`)
                .then(response => response.json())
                .then(data => {
                    if (data.code === 200) {
                        displayEnrolledCourses(data.data);
                    } else {
                        document.getElementById('courses-list').innerHTML = `<p>加载失败: ${data.msg}</p>`;
                    }
                })
                .catch(error => {
                    console.error('获取课程数据失败:', error);
                    document.getElementById('courses-list').innerHTML = '<p>加载课程数据失败，请稍后重试</p>';
                });
        }
        
        // 显示已选课程列表
        function displayEnrolledCourses(courses) {
            const coursesList = document.getElementById('courses-list');
            
            // 获取搜索框中的搜索词
            const searchTerm = document.getElementById('course-search') ? document.getElementById('course-search').value.toLowerCase() : '';
            
            // 如果有搜索词，则过滤课程列表
            if (searchTerm) {
                courses = courses.filter(course => {
                    return (course.courseName && course.courseName.toLowerCase().includes(searchTerm)) ||
                           (course.teacherName && course.teacherName.toLowerCase().includes(searchTerm)) ||
                           (course.courseCode && course.courseCode.toLowerCase().includes(searchTerm));
                });
            }
            
            if (!courses || courses.length === 0) {
                coursesList.innerHTML = `
                    <div class="no-data">
                        <i class="fas fa-book"></i>
                        <h3>无对应课程</h3>
                        <p>没有找到符合搜索条件的课程</p>
                    </div>
                `;
                return;
            }
            
            let tableHtml = `
                <table>
                    <thead>
                        <tr>
                            <th>课程编号</th>
                            <th>课程名称</th>
                            <th>学分</th>
                            <th>教师</th>
                            <th>描述</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            courses.forEach(course => {
                tableHtml += `
                    <tr>
                        <td>${course.courseCode || ''}</td>
                        <td>${course.courseName || ''}</td>
                        <td>${course.credits || 0}</td>
                        <td>${course.teacherName || ''}</td>
                        <td>${course.description || ''}</td>
                        <td>
                            <button class="btn-select" style="padding: 6px 12px; font-size: 14px; margin-right: 5px;" onclick="viewCourseDetails(${course.id}, '${course.courseName}')">查看详情</button>
                            <button class="btn-danger" style="padding: 6px 12px; font-size: 14px;" onclick="unenrollCourse(${course.id}, '${course.courseName}')">退选</button>
                        </td>
                    </tr>
                `;
            });
            
            tableHtml += `
                    </tbody>
                </table>
            `;
            
            coursesList.innerHTML = tableHtml;
        }
        
        // 搜索已选课程
        function searchEnrolledCourses() {
            const searchTerm = document.getElementById('course-search').value.toLowerCase();
            
            // 重新加载课程数据
            loadEnrolledCourses();
        }
        
        // 加载可选课程数据
        function loadAvailableCourses() {
            const currentUser = JSON.parse(sessionStorage.getItem('currentUser'));
            if (!currentUser) {
                document.getElementById('available-courses-list').innerHTML = '<p>请先登录</p>';
                return;
            }
            
            // 调用后端API获取所有课程
            fetch('/api/courses')
                .then(response => response.json())
                .then(data => {
                    if (data.code === 200) {
                        // 同时获取学生已选课程，以便正确显示选课状态
                        fetch(`/api/student-courses/student/${currentUser.id}/courses`)
                            .then(response => response.json())
                            .then(enrolledData => {
                                if (enrolledData.code === 200) {
                                    // 更新已选课程ID列表
                                    enrolledCourseIds = enrolledData.data.map(course => course.id);
                                    displayAvailableCourses(data.data);
                                } else {
                                    document.getElementById('available-courses-list').innerHTML = `<p>加载失败: ${enrolledData.msg}</p>`;
                                }
                            })
                            .catch(error => {
                                console.error('获取已选课程数据失败:', error);
                                // 即使无法获取已选课程，也要显示可选课程
                                displayAvailableCourses(data.data);
                            });
                    } else {
                        document.getElementById('available-courses-list').innerHTML = `<p>加载失败: ${data.msg}</p>`;
                    }
                })
                .catch(error => {
                    console.error('获取课程数据失败:', error);
                    document.getElementById('available-courses-list').innerHTML = '<p>加载课程数据失败，请稍后重试</p>';
                });
        }
        
        // 显示可选课程列表
        function displayAvailableCourses(courses) {
            const teacherSearchTerm = document.getElementById('teacher-search').value.toLowerCase();
            const courseNameSearchTerm = document.getElementById('course-name-search').value.toLowerCase();
            
            // 根据搜索条件过滤课程
            if (teacherSearchTerm || courseNameSearchTerm) {
                courses = courses.filter(course => {
                    const teacherMatch = teacherSearchTerm ? 
                        (course.teacherName && course.teacherName.toLowerCase().includes(teacherSearchTerm)) : true;
                    const courseMatch = courseNameSearchTerm ? 
                        (course.courseName && course.courseName.toLowerCase().includes(courseNameSearchTerm)) : true;
                    return teacherMatch && courseMatch;
                });
            }
            
            const coursesList = document.getElementById('available-courses-list');
            if (!courses || courses.length === 0) {
                coursesList.innerHTML = `
                    <div class="no-data">
                        <i class="fas fa-book"></i>
                        <h3>未找到对应课程</h3>
                        <p>没有符合条件的课程，请尝试其他搜索条件</p>
                    </div>
                `;
                return;
            }
            
            let tableHtml = `
                <table>
                    <thead>
                        <tr>
                            <th>课程编号</th>
                            <th>课程名称</th>
                            <th>学分</th>
                            <th>教师</th>
                            <th>描述</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            courses.forEach(course => {
                // 检查课程是否已选
                const isEnrolled = enrolledCourseIds.includes(course.id);
                const buttonClass = isEnrolled ? 'btn-selected' : 'btn-select';
                const buttonText = isEnrolled ? '已选' : '选课';
                const buttonOnclick = isEnrolled ? 
                    `unenrollCourse(${course.id}, '${course.courseName}')` : 
                    `enrollCourse(${course.id}, '${course.courseName}')`;
                
                tableHtml += `
                    <tr>
                        <td>${course.courseCode || ''}</td>
                        <td>${course.courseName || ''}</td>
                        <td>${course.credits || 0}</td>
                        <td>${course.teacherName || ''}</td>
                        <td>${course.description || ''}</td>
                        <td>
                            <button class="${buttonClass}" style="padding: 6px 12px; font-size: 14px;" onclick="${buttonOnclick}">${buttonText}</button>
                        </td>
                    </tr>
                `;
            });
            
            tableHtml += `
                    </tbody>
                </table>
            `;
            
            coursesList.innerHTML = tableHtml;
        }
        
        // 搜索可选课程
        function searchAvailableCourses() {
            // 重新加载并显示课程（过滤将在displayAvailableCourses中处理）
            loadAvailableCourses();
        }
        
        // 选课
        function enrollCourse(courseId, courseName) {
            const currentUser = JSON.parse(sessionStorage.getItem('currentUser'));
            if (!currentUser) {
                alert('请先登录');
                return;
            }
            
            // 调用后端API选课
            fetch(`/api/student-courses/${currentUser.id}/${courseId}`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.code === 200) {
                    alert(`成功选择课程: ${courseName}`);
                    // 更新已选课程ID列表
                    enrolledCourseIds.push(courseId);
                    // 重新加载可选课程列表以更新按钮状态
                    loadAvailableCourses();
                    // 刷新消息列表以显示新消息
                    if (document.querySelector('#messages.active')) {
                        loadMessages();
                    }
                    
                    // 刷新已选课程列表
                    if (document.querySelector('#courses.active')) {
                        loadEnrolledCourses();
                    }
                    

                } else {
                    alert(`选课失败: ${data.msg}`);
                }
            })
            .catch(error => {
                console.error('选课失败:', error);
                alert('选课失败，请稍后重试');
            });
        }
        
        // 退选课程
        function unenrollCourse(courseId, courseName) {
            const currentUser = JSON.parse(sessionStorage.getItem('currentUser'));
            if (!currentUser) {
                alert('请先登录');
                return;
            }
            
            // 确认是否退选
            if (!confirm(`确定要退选课程"${courseName}"吗？`)) {
                return;
            }
            
            // 调用后端API退选
            fetch(`/api/student-courses/${currentUser.id}/${courseId}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.code === 200) {
                    alert(`成功退选课程: ${courseName}`);
                    // 从已选课程ID列表中移除
                    const index = enrolledCourseIds.indexOf(courseId);
                    if (index > -1) {
                        enrolledCourseIds.splice(index, 1);
                    }
                    // 重新加载可选课程列表以更新按钮状态
                    loadAvailableCourses();
                    // 刷新消息列表以显示新消息
                    if (document.querySelector('#messages.active')) {
                        loadMessages();
                    }
                    
                    // 刷新已选课程列表
                    if (document.querySelector('#courses.active')) {
                        loadEnrolledCourses();
                    }
                    

                } else {
                    alert(`退选失败: ${data.msg}`);
                }
            })
            .catch(error => {
                console.error('退选失败:', error);
                alert('退选失败，请稍后重试');
            });
        }
        
        // 查看课程详情
        function viewCourseDetails(courseId, courseName) {
            // 将课程信息存储到sessionStorage
            sessionStorage.setItem('viewingCourseId', courseId);
            sessionStorage.setItem('viewingCourseName', courseName);
            
            // 跳转到课程详情页面
            window.location.href = `course-detail.html?courseId=${courseId}`;
        }
        
        // 加载作业数据
        function loadAssignments() {
            const currentUser = JSON.parse(sessionStorage.getItem('currentUser'));
            if (!currentUser) {
                document.getElementById('assignments-list').innerHTML = '<p>请先登录</p>';
                return;
            }
            
            // 显示加载状态
            document.getElementById('assignments-list').innerHTML = '<p>加载中...</p>';
            
            // 首先获取学生已选课程
            fetch(`/api/student-courses/student/${currentUser.id}/courses`)
                .then(response => response.json())
                .then(courseData => {
                    if (courseData.code === 200 && courseData.data) {
                        // 获取所有课程ID
                        const courseIds = courseData.data.map(course => course.id);
                        
                        // 获取所有课程的作业
                        let allAssignments = [];
                        let loadedCount = 0;
                        
                        if (courseIds.length === 0) {
                            document.getElementById('assignments-list').innerHTML = '<p>暂无已选课程，无法加载作业</p>';
                            return;
                        }
                        
                        courseIds.forEach(courseId => {
                            fetch(`/api/assignments/course/${courseId}`)
                                .then(response => response.json())
                                .then(assignmentData => {
                                    if (assignmentData.code === 200 && assignmentData.data) {
                                        allAssignments = allAssignments.concat(assignmentData.data);
                                    }
                                    
                                    loadedCount++;
                                    if (loadedCount === courseIds.length) {
                                        // 按发布时间倒序排序（发布越晚的在越上面）
                                        allAssignments.sort((a, b) => {
                                            const timeA = a.createTime ? new Date(a.createTime).getTime() : 0;
                                            const timeB = b.createTime ? new Date(b.createTime).getTime() : 0;
                                            return timeB - timeA;
                                        });
                                        displayAssignments(allAssignments);
                                    }
                                })
                                .catch(error => {
                                    console.error('获取课程作业失败:', error);
                                    loadedCount++;
                                    if (loadedCount === courseIds.length) {
                                        // 按发布时间倒序排序（发布越晚的在越上面）
                                        allAssignments.sort((a, b) => {
                                            const timeA = a.createTime ? new Date(a.createTime).getTime() : 0;
                                            const timeB = b.createTime ? new Date(b.createTime).getTime() : 0;
                                            return timeB - timeA;
                                        });
                                        displayAssignments(allAssignments);
                                    }
                                });
                        });
                    } else {
                        document.getElementById('assignments-list').innerHTML = '<p>获取已选课程失败</p>';
                    }
                })
                .catch(error => {
                    console.error('获取已选课程失败:', error);
                    document.getElementById('assignments-list').innerHTML = '<p>加载作业数据失败</p>';
                });
        }
        
        // 显示作业列表
        function displayAssignments(assignments) {
            const assignmentsList = document.getElementById('assignments-list');
            if (!assignments || assignments.length === 0) {
                assignmentsList.innerHTML = '<p>暂无作业</p>';
                return;
            }
            
            // 首先获取学生的提交记录（需要带上身份信息，否则后端会认为“未登录”）
            const currentUser = JSON.parse(sessionStorage.getItem('currentUser'));
            const submissionHeaders = currentUser ? {
                'X-User-Id': currentUser.id,
                'X-User-Role': currentUser.role
            } : {};
            
            fetch(`/api/submissions/student/${currentUser.id}`, {
                headers: submissionHeaders
            })
                .then(response => response.json())
                .then(submissionData => {
                    let tableHtml = `
                        <table>
                            <thead>
                                <tr>
                                    <th>作业名称</th>
                                    <th>课程</th>
                                    <th>截止日期</th>
                                    <th>状态</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;
                    
                    if (submissionData.code === 200 && submissionData.data) {
                        // 创建提交记录映射，以提高查找效率
                        const submissionMap = {};
                        submissionData.data.forEach(sub => {
                            submissionMap[sub.assignmentId] = sub;
                        });
                        
                        assignments.forEach(assignment => {
                            const userSubmission = submissionMap[assignment.id];
                            const statusText = userSubmission ? '已提交' : '未提交';
                            const statusClass = userSubmission ? 'd4edda' : 'ffebcc';
                            const statusColor = userSubmission ? '28a745' : 'ff9900';
                            
                            // 检查作业是否已过期
                            const isOverdue = assignment.deadline && new Date(assignment.deadline) < new Date();
                            
                            // 安全地转义标题和课程名称，避免引号问题
                            const safeTitle = (assignment.title || '').replace(/'/g, "\\'").replace(/"/g, '&quot;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
                            const safeCourseName = (assignment.courseName || '').replace(/'/g, "\\'").replace(/"/g, '&quot;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
                            
                            // 根据提交状态和是否过期决定按钮文本和状态显示
                            let statusDisplay = '';
                            let statusBgColor = '';
                            let statusTextColor = '';
                            let buttonText = '';
                            let buttonClass = '';
                            let operationHtml = '';
                            
                            if (isOverdue) {
                                statusDisplay = '已逾期';
                                statusBgColor = '#f8d7da';
                                statusTextColor = '#721c24';
                                operationHtml = '<span style="background-color: #f8d7da; color: #721c24; padding: 4px 8px; border-radius: 4px;">已逾期</span>';
                            } else {
                                if (userSubmission) {
                                    // 检查是否已评分
                                    if (userSubmission.grade !== undefined && userSubmission.grade !== null) {
                                        statusDisplay = `已评分: ${userSubmission.grade}分`;
                                        statusBgColor = '#cce5ff';
                                        statusTextColor = '#004085';
                                        buttonText = '查看分数';
                                        buttonClass = 'btn-outline';
                                    // 统一入口：查看详情页内可下载教师附件并提交/修改作业
                                    operationHtml = `<button class="btn-outline" onclick="showSubmissionPage(${assignment.id}, '${safeTitle}', '${safeCourseName}')">查看详情</button>`;
                                    } else {
                                        statusDisplay = '已提交';
                                        statusBgColor = '#d4edda';
                                        statusTextColor = '#28a745';
                                    operationHtml = `<button class="btn-outline" onclick="showSubmissionPage(${assignment.id}, '${safeTitle}', '${safeCourseName}')">查看详情</button>`;
                                    }
                                } else {
                                    statusDisplay = '未提交';
                                    statusBgColor = '#fff3cd';
                                    statusTextColor = '#856404';
                                operationHtml = `<button class="btn-outline" onclick="showSubmissionPage(${assignment.id}, '${safeTitle}', '${safeCourseName}')">查看详情</button>`;
                                }
                            }
                            
                            tableHtml += `
                                <tr>
                                    <td>${assignment.title || ''}</td>
                                    <td>${assignment.courseName || ''}</td>
                                    <td>${assignment.deadline ? new Date(assignment.deadline).toLocaleDateString() : 'N/A'}</td>
                                    <td><span style="background-color: ${statusBgColor}; color: ${statusTextColor}; padding: 4px 8px; border-radius: 4px;">${statusDisplay}</span></td>
                                    <td>
                                        ${operationHtml}
                                    </td>
                                </tr>
                            `;
                        });
                    } else {
                        // 如果获取提交记录失败，仍然显示作业列表，但状态为未知
                        assignments.forEach(assignment => {
                            // 检查作业是否已过期
                            const isOverdue = assignment.deadline && new Date(assignment.deadline) < new Date();
                            
                            // 安全地转义标题和课程名称，避免引号问题
                            const safeTitle = (assignment.title || '').replace(/'/g, "\\'").replace(/"/g, '&quot;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
                            const safeCourseName = (assignment.courseName || '').replace(/'/g, "\\'").replace(/"/g, '&quot;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
                            
                            let statusDisplay = '';
                            let statusBgColor = '';
                            let statusTextColor = '';
                            let operationHtml = '';
                            
                            if (isOverdue) {
                                statusDisplay = '已逾期';
                                statusBgColor = '#f8d7da';
                                statusTextColor = '#721c24';
                                operationHtml = '<span style="background-color: #f8d7da; color: #721c24; padding: 4px 8px; border-radius: 4px;">已逾期</span>';
                            } else {
                                statusDisplay = '未提交';
                                statusBgColor = '#fff3cd';
                                statusTextColor = '#856404';
                                operationHtml = `<button class="btn-outline" onclick="showSubmissionPage(${assignment.id}, '${safeTitle}', '${safeCourseName}')">查看详情</button>`;
                            }
                            
                            tableHtml += `
                                <tr>
                                    <td>${assignment.title || ''}</td>
                                    <td>${assignment.courseName || ''}</td>
                                    <td>${assignment.deadline ? new Date(assignment.deadline).toLocaleDateString() : 'N/A'}</td>
                                    <td><span style="background-color: ${statusBgColor}; color: ${statusTextColor}; padding: 4px 8px; border-radius: 4px;">${statusDisplay}</span></td>
                                    <td>
                                        ${operationHtml}
                                    </td>
                                </tr>
                            `;
                        });
                    }
                    
                    tableHtml += `
                            </tbody>
                        </table>
                    `;
                    
                    assignmentsList.innerHTML = tableHtml;
                })
                .catch(error => {
                    console.error('获取提交记录失败:', error);
                    
                    // 即使获取提交记录失败，也显示作业列表
                    let tableHtml = `
                        <table>
                            <thead>
                                <tr>
                                    <th>作业名称</th>
                                    <th>课程</th>
                                    <th>截止日期</th>
                                    <th>状态</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;
                    
                    assignments.forEach(assignment => {
                        // 检查作业是否已过期
                        const isOverdue = assignment.deadline && new Date(assignment.deadline) < new Date();
                        
                        // 安全地转义标题和课程名称，避免引号问题
                        const safeTitle = (assignment.title || '').replace(/'/g, "\\'").replace(/"/g, '&quot;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
                        const safeCourseName = (assignment.courseName || '').replace(/'/g, "\\'").replace(/"/g, '&quot;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
                        
                        let operationHtml = '';
                        if (isOverdue) {
                            operationHtml = '<span style="background-color: #f8d7da; color: #721c24; padding: 4px 8px; border-radius: 4px;">已逾期</span>';
                        } else {
                            operationHtml = `<button class="btn-outline" onclick="showSubmissionPage(${assignment.id}, '${safeTitle}', '${safeCourseName}')">查看详情</button>`;
                        }
                        
                        tableHtml += `
                            <tr>
                                <td>${assignment.title || ''}</td>
                                <td>${assignment.courseName || ''}</td>
                                <td>${assignment.deadline ? new Date(assignment.deadline).toLocaleDateString() : 'N/A'}</td>
                                <td><span style="background-color: #ffebcc; color: #ff9900; padding: 4px 8px; border-radius: 4px;">未知</span></td>
                                <td>
                                    ${operationHtml}
                                </td>
                            </tr>
                        `;
                    });
                    
                    tableHtml += `
                            </tbody>
                        </table>
                    `;
                    
                    assignmentsList.innerHTML = tableHtml;
                });
        }
        
        // 搜索作业
        function searchAssignments() {
            const searchTerm = document.getElementById('assignment-search').value.toLowerCase();
            // 模拟搜索功能
            loadAssignments(); // 实际项目中应根据搜索词筛选数据
        }
        
        // 加载提交记录
        function loadSubmissions() {
            const submissionsList = document.getElementById('submissions-list');
            if (!submissionsList) return;
            
            submissionsList.innerHTML = '<p>加载中...</p>';
            
            const currentUser = JSON.parse(sessionStorage.getItem('currentUser'));
            if (!currentUser) {
                submissionsList.innerHTML = '<p>请先登录</p>';
                return;
            }
            
            fetch(`/api/submissions/student/${currentUser.id}`, {
                headers: {
                    'X-User-Id': currentUser.id,
                    'X-User-Role': currentUser.role
                }
            })
                .then(response => response.json())
                .then(data => {
                    if (data.code === 200 && data.data) {
                        displaySubmissions(data.data);
                    } else {
                        submissionsList.innerHTML = `<p>加载失败: ${data.msg || '未知错误'}</p>`;
                    }
                })
                .catch(error => {
                    console.error('获取提交记录失败:', error);
                    submissionsList.innerHTML = '<p>加载提交记录失败，请稍后重试</p>';
                });
        }
        
        // 显示提交记录
        function displaySubmissions(submissions) {
            const submissionsList = document.getElementById('submissions-list');
            if (!submissions || submissions.length === 0) {
                submissionsList.innerHTML = '<p>暂无提交记录</p>';
                return;
            }
            
            let tableHtml = `
                <table style="width:100%;border-collapse:collapse;">
                    <thead>
                        <tr style="background:#f4f7fe;text-align:left;">
                            <th style="padding:12px;">作业名称</th>
                            <th style="padding:12px;">提交时间</th>
                            <th style="padding:12px;">状态</th>
                            <th style="padding:12px;">分数</th>
                            <th style="padding:12px;">操作</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            submissions.forEach(submission => {
                const statusText = submission.status === 1 ? '已批阅' : '已提交';
                const statusClass = submission.status === 1 ? 'status-graded' : 'status-submitted';
                const statusStyle = submission.status === 1 
                    ? 'background-color: #d4edda; color: #28a745; padding: 4px 8px; border-radius: 4px;'
                    : 'background-color: #ffebcc; color: #ff9900; padding: 4px 8px; border-radius: 4px;';
                const score = submission.score !== null && submission.score !== undefined ? submission.score + '分' : '-';
                
                let operationHtml = '';
                if (submission.status === 0) {
                    // 未批阅状态，可以撤回和修改
                    operationHtml = `
                        <button class="btn-select" style="padding: 6px 12px; font-size: 14px; margin-right: 5px;" onclick="editSubmission(${submission.id})">修改</button>
                        <button class="btn-danger" style="padding: 6px 12px; font-size: 14px;" onclick="withdrawSubmission(${submission.id})">撤回</button>
                    `;
                } else {
                    // 已批阅状态，只能查看
                    operationHtml = `
                        <button class="btn-select" style="padding: 6px 12px; font-size: 14px;" onclick="viewSubmissionDetail(${submission.id})">查看详情</button>
                    `;
                }
                
                tableHtml += `
                    <tr>
                        <td style="padding:12px;border-bottom:1px solid #e0e5f2;">${submission.assignmentTitle || '作业' + submission.assignmentId}</td>
                        <td style="padding:12px;border-bottom:1px solid #e0e5f2;">${submission.createTime ? new Date(submission.createTime).toLocaleString() : '-'}</td>
                        <td style="padding:12px;border-bottom:1px solid #e0e5f2;"><span style="${statusStyle}">${statusText}</span></td>
                        <td style="padding:12px;border-bottom:1px solid #e0e5f2;">${score}</td>
                        <td style="padding:12px;border-bottom:1px solid #e0e5f2;">${operationHtml}</td>
                    </tr>
                `;
            });
            
            tableHtml += `
                    </tbody>
                </table>
            `;
            
            submissionsList.innerHTML = tableHtml;
        }
        
        // 撤回提交
        function withdrawSubmission(submissionId) {
            if (!confirm('确定要撤回此作业提交吗？撤回后可以重新提交。')) {
                return;
            }
            
            const currentUser = JSON.parse(sessionStorage.getItem('currentUser'));
            if (!currentUser) {
                alert('请先登录');
                return;
            }
            
            fetch(`/api/submissions/${submissionId}`, {
                method: 'DELETE',
                headers: {
                    'X-User-Id': currentUser.id,
                    'X-User-Role': currentUser.role
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.code === 200) {
                    alert('撤回成功！');
                    loadSubmissions();
                    loadAssignments(); // 刷新作业列表
                } else {
                    alert('撤回失败: ' + (data.msg || '未知错误'));
                }
            })
            .catch(error => {
                console.error('撤回失败:', error);
                alert('撤回失败，请稍后重试');
            });
        }
        
        // 编辑提交
        function editSubmission(submissionId) {
            // 存储当前编辑的提交ID
            sessionStorage.setItem('editingSubmissionId', submissionId);
            
            // 获取提交详情
            const currentUser = JSON.parse(sessionStorage.getItem('currentUser'));
            if (!currentUser) {
                alert('请先登录');
                return;
            }
            
            fetch(`/api/submissions/${submissionId}`, {
                headers: {
                    'X-User-Id': currentUser.id,
                    'X-User-Role': currentUser.role
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.code === 200 && data.data) {
                    const submission = data.data;
                    // 填充表单
                    document.getElementById('assignment-id').value = submission.assignmentId;
                    document.getElementById('submission-content').value = submission.content || '';
                    // 切换到提交作业区域
                    document.getElementById('submissions').scrollIntoView({ behavior: 'smooth' });
                } else {
                    alert('获取提交详情失败: ' + (data.msg || '未知错误'));
                }
            })
            .catch(error => {
                console.error('获取提交详情失败:', error);
                alert('获取提交详情失败，请稍后重试');
            });
        }
        
        // 查看提交详情
        function viewSubmissionDetail(submissionId) {
            window.location.href = `submission-view.html?submissionId=${submissionId}`;
        }
        
        // 搜索提交记录
        function searchSubmissions() {
            const searchTerm = document.getElementById('submission-search').value.toLowerCase();
            // 模拟搜索功能
            loadSubmissions(); // 实际项目中应根据搜索词筛选数据
        }
        
        // 加载消息
        function loadMessages() {
            const messagesList = document.getElementById('messages-list');
            if (!messagesList) {
                console.error('消息列表元素不存在');
                return;
            }
            
            // 显示加载状态
            messagesList.innerHTML = '<p>加载中...</p>';
            
            // 获取当前用户信息
            const currentUser = JSON.parse(sessionStorage.getItem('currentUser'));
            if (!currentUser) {
                messagesList.innerHTML = '<p>请先登录</p>'; 
                return;
            }
            
            // 调用后端API获取用户消息
            fetch(`/api/messages/user/${currentUser.id}`)
                .then(response => response.json())
                .then(data => {
                    if (data.code === 200 && data.data) {
                        displayMessages(data.data);
                    } else {
                        messagesList.innerHTML = `<p>加载失败: ${data.msg}</p>`;
                    }
                })
                .catch(error => {
                    console.error('获取消息失败:', error);
                    messagesList.innerHTML = '<p>加载消息失败，请稍后重试</p>';
                });
        }
        
        // 显示消息列表
        function displayMessages(messages) {
            const messagesList = document.getElementById('messages-list');
            if (!messages || messages.length === 0) {
                messagesList.innerHTML = '<p>暂无消息</p>';
                return;
            }
            
            let tableHtml = `
                <div class="message-actions">
                    <button class="btn-danger" onclick="batchDeleteMessages()">
                        <i class="fas fa-trash"></i> 批量删除
                    </button>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th class="message-checkbox-cell"><input type="checkbox" id="select-all" onclick="toggleSelectAll()"></th>
                            <th>标题</th>
                            <th>时间</th>
                            <th>状态</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            messages.forEach(message => {
                const statusText = message.status === 1 ? '已读' : '未读';
                const statusClass = message.status === 1 ? 'd4edda' : 'fff3cd';
                const statusColor = message.status === 1 ? '28a745' : '856404';
                
                // 转义特殊字符，防止XSS攻击
                const safeTitle = (message.title || '').replace(/'/g, "\\'").replace(/"/g, '&quot;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
                
                tableHtml += `
                    <tr>
                        <td class="message-checkbox-cell"><input type="checkbox" class="message-checkbox" data-id="${message.id}"></td>
                        <td>${message.title || ''}</td>
                        <td>${message.createTime ? new Date(message.createTime).toLocaleString() : 'N/A'}</td>
                        <td><span class="message-status" style="background-color: #${statusClass}; color: #${statusColor};">${statusText}</span></td>
                        <td>
                            <button class="btn-select message-operation" onclick="viewMessageDetail(${message.id}, '${safeTitle}')">查看详情</button>
                        </td>
                    </tr>
                `;
            });
            
            tableHtml += `
                    </tbody>
                </table>
            `;
            
            messagesList.innerHTML = tableHtml;
        }
        
        // 查看消息详情
        function viewMessageDetail(messageId, messageTitle) {
            // 跳转到消息详情页面
            window.location.href = `message-detail.html?id=${messageId}`;
        }
        
        // 搜索消息
        function searchMessages() {
            const searchTerm = document.getElementById('message-search').value.toLowerCase();
            // 模拟搜索功能
            loadMessages(); // 实际项目中应根据搜索词筛选数据
        }
        
        // 全选/取消全选
        function toggleSelectAll() {
            const selectAllCheckbox = document.getElementById('select-all');
            const checkboxes = document.querySelectorAll('.message-checkbox');
            
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAllCheckbox.checked;
            });
        }
        
        // 检查是否需要取消全选状态
        function checkSelectAllStatus() {
            const selectAllCheckbox = document.getElementById('select-all');
            const checkboxes = document.querySelectorAll('.message-checkbox');
            const checkedCount = document.querySelectorAll('.message-checkbox:checked').length;
            
            selectAllCheckbox.checked = checkboxes.length === checkedCount;
        }
        
        // 批量删除消息
        function batchDeleteMessages() {
            const selectedCheckboxes = document.querySelectorAll('.message-checkbox:checked');
            
            if (selectedCheckboxes.length === 0) {
                alert('请至少选择一条消息');
                return;
            }
            
            if (!confirm(`确定要删除选中的 ${selectedCheckboxes.length} 条消息吗？此操作不可恢复！`)) {
                return;
            }
            
            // 获取选中的消息ID
            const messageIds = Array.from(selectedCheckboxes).map(checkbox => 
                parseInt(checkbox.getAttribute('data-id'))
            );
            
            // 发送批量删除请求
            fetch('/api/messages/batch', {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(messageIds)
            })
            .then(response => response.json())
            .then(data => {
                if (data.code === 200) {
                    alert(`成功删除 ${selectedCheckboxes.length} 条消息！`);
                    // 重新加载消息列表
                    loadMessages();
                } else {
                    alert('删除失败: ' + (data.msg || '未知错误'));
                }
            })
            .catch(error => {
                console.error('批量删除消息失败:', error);
                alert('删除失败，请稍后重试');
            });
        }
        
        // 显示文件列表
        function updateFileList() {
            const fileInput = document.getElementById('submission-files');
            const fileListDiv = document.getElementById('file-list');
            if (fileInput && fileListDiv && fileInput.files.length > 0) {
                let fileListHtml = '<div style="margin-top: 5px;">已选择文件：</div>';
                for (let i = 0; i < fileInput.files.length; i++) {
                    fileListHtml += `<div style="margin-top: 5px;">${fileInput.files[i].name} (${(fileInput.files[i].size / 1024).toFixed(2)} KB)</div>`;
                }
                fileListDiv.innerHTML = fileListHtml;
            } else if (fileListDiv) {
                fileListDiv.innerHTML = '';
            }
        }
        
        // 提交作业
        function submitAssignment() {
            const assignmentId = document.getElementById('assignment-id').value;
            const content = document.getElementById('submission-content').value;
            const fileInput = document.getElementById('submission-files');
            const resultElement = document.getElementById('submission-result');
            
            if (!assignmentId || !content) {
                resultElement.innerHTML = '<p style="color: #ff5b5b;">请填写作业ID和内容</p>';
                return;
            }
            
            // 获取当前用户信息
            const currentUser = JSON.parse(sessionStorage.getItem('currentUser'));
            if (!currentUser) {
                resultElement.innerHTML = '<p style="color: #ff5b5b;">请先登录</p>';
                return;
            }
            
            // 检查是否为编辑模式
            const editingSubmissionId = sessionStorage.getItem('editingSubmissionId');
            
            if (editingSubmissionId) {
                // 编辑模式：更新提交
                const formData = new FormData();
                formData.append('content', content);
                
                // 添加文件（如果有新文件）
                if (fileInput && fileInput.files.length > 0) {
                    for (let i = 0; i < fileInput.files.length; i++) {
                        formData.append('files', fileInput.files[i]);
                    }
                }
                
                fetch(`/api/submissions/${editingSubmissionId}/student`, {
                    method: 'PUT',
                    headers: {
                        'X-User-Id': currentUser.id,
                        'X-User-Role': currentUser.role
                    },
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.code === 200) {
                        resultElement.innerHTML = '<p style="color: green;">作业修改成功！</p>';
                        sessionStorage.removeItem('editingSubmissionId');
                        // 清空表单
                        document.getElementById('assignment-id').value = '';
                        document.getElementById('submission-content').value = '';
                        if (fileInput) {
                            fileInput.value = '';
                        }
                        const fileListDiv = document.getElementById('file-list');
                        if (fileListDiv) {
                            fileListDiv.innerHTML = '';
                        }
                        loadSubmissions();
                        loadAssignments();
                    } else {
                        resultElement.innerHTML = '<p style="color: #ff5b5b;">作业修改失败: ' + (data.msg || '未知错误') + '</p>';
                    }
                })
                .catch(error => {
                    console.error('作业修改失败:', error);
                    resultElement.innerHTML = '<p style="color: #ff5b5b;">作业修改失败，请稍后重试</p>';
                });
            } else {
                // 新建模式：创建提交
                const formData = new FormData();
                formData.append('assignmentId', assignmentId);
                formData.append('studentId', currentUser.id);
                formData.append('content', content);
                
                // 添加文件
                if (fileInput && fileInput.files.length > 0) {
                    for (let i = 0; i < fileInput.files.length; i++) {
                        formData.append('files', fileInput.files[i]);
                    }
                }
                
                // 发送提交请求到后端
                fetch('/api/submissions', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.code === 200) {
                        resultElement.innerHTML = '<p style="color: green;">作业提交成功！</p>';
                        
                        // 清空表单
                        document.getElementById('assignment-id').value = '';
                        document.getElementById('submission-content').value = '';
                        if (fileInput) {
                            fileInput.value = '';
                        }
                        const fileListDiv = document.getElementById('file-list');
                        if (fileListDiv) {
                            fileListDiv.innerHTML = '';
                        }
                        
                        // 重新加载提交记录
                        loadSubmissions();
                        
                        // 更新作业列表中的状态
                        setTimeout(() => {
                            loadAssignments();
                        }, 1000);
                    } else {
                        resultElement.innerHTML = '<p style="color: #ff5b5b;">作业提交失败: ' + (data.msg || '未知错误') + '</p>';
                    }
                })
                .catch(error => {
                    console.error('作业提交失败:', error);
                    resultElement.innerHTML = '<p style="color: #ff5b5b;">作业提交失败，请稍后重试</p>';
                });
            }
        }
        
        // 显示作业提交页面
        function showSubmissionPage(assignmentId, assignmentTitle, courseName) {
            // 兼容旧逻辑：仍写入 sessionStorage，方便其它页面使用
            sessionStorage.setItem('currentAssignmentId', assignmentId);
            sessionStorage.setItem('currentAssignmentTitle', assignmentTitle);
            sessionStorage.setItem('currentCourseName', courseName);
            // 统一进入详情页：详情页里支持下载教师附件 + 上传/修改提交
            window.location.href = `submission-view.html?assignmentId=${assignmentId}`;
        }
        
        // 发送消息给管理员
        function sendMessageToAdmin() {
            const title = document.getElementById('admin-message-title').value;
            const content = document.getElementById('admin-message-content').value;
            const resultElement = document.getElementById('admin-send-message-result');
            
            if (!title || !content) {
                resultElement.innerHTML = '<p style="color: #ff5b5b;">请填写标题和内容</p>';
                return;
            }
            
            const currentUser = JSON.parse(sessionStorage.getItem('currentUser'));
            if (!currentUser) {
                resultElement.innerHTML = '<p style="color: #ff5b5b;">请先登录</p>';
                return;
            }
            
            // 获取管理员ID
            fetch('/api/users/admin')
                .then(response => response.json())
                .then(adminData => {
                    if (adminData.code === 200 && adminData.data) {
                        const messageData = {
                            // 使用 type: 'admins'，让后端给所有管理员账号都发一份
                            type: 'admins',
                            title: title,
                            content: content,
                            sender: `${currentUser.realName || currentUser.username} (学生)`
                        };
                        
                        fetch('/api/messages/send', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(messageData)
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.code === 200) {
                                resultElement.innerHTML = '<p style="color: green;">消息发送成功！</p>';
                                
                                // 清空表单
                                document.getElementById('admin-message-title').value = '';
                                document.getElementById('admin-message-content').value = '';
                                
                                // 5秒后清除提示
                                setTimeout(() => {
                                    resultElement.innerHTML = '';
                                }, 5000);
                            } else {
                                resultElement.innerHTML = '<p style="color: #ff5b5b;">发送失败: ' + data.msg + '</p>';
                            }
                        })
                        .catch(error => {
                            console.error('发送消息失败:', error);
                            resultElement.innerHTML = '<p style="color: #ff5b5b;">发送消息失败，请稍后重试</p>';
                        });
                    } else {
                        resultElement.innerHTML = '<p style="color: #ff5b5b;">获取管理员信息失败</p>';
                    }
                })
                .catch(error => {
                    console.error('获取管理员信息失败:', error);
                    resultElement.innerHTML = '<p style="color: #ff5b5b;">获取管理员信息失败，请稍后重试</p>';
                });
        }
        
        // 加载学生已选课程到发送消息页面
        function loadStudentCoursesForMessaging() {
            const currentUser = JSON.parse(sessionStorage.getItem('currentUser'));
            if (!currentUser) {
                return;
            }
            
            // 获取学生已选课程
            fetch(`/api/student-courses/student/${currentUser.id}/courses`)
                .then(response => response.json())
                .then(data => {
                    const courseSelect = document.getElementById('teacher-course');
                    if (data.code === 200 && data.data) {
                        // 清空现有选项
                        courseSelect.innerHTML = '<option value="">请选择课程</option>';
                        
                        // 添加新选项
                        data.data.forEach(course => {
                            const option = document.createElement('option');
                            option.value = course.id;
                            option.textContent = course.courseName;
                            courseSelect.appendChild(option);
                        });
                    } else {
                        courseSelect.innerHTML = '<option value="">获取课程列表失败</option>';
                    }
                })
                .catch(error => {
                    console.error('获取课程列表失败:', error);
                    const courseSelect = document.getElementById('teacher-course');
                    courseSelect.innerHTML = '<option value="">获取课程列表失败</option>';
                });
        }
        
        // 发送消息给教师
        function sendMessageToTeacher() {
            const courseId = document.getElementById('teacher-course').value;
            const title = document.getElementById('teacher-message-title').value;
            const content = document.getElementById('teacher-message-content').value;
            const resultElement = document.getElementById('teacher-send-message-result');
            
            if (!courseId || !title || !content) {
                resultElement.innerHTML = '<p style="color: #ff5b5b;">请选择课程并填写标题和内容</p>';
                return;
            }
            
            const currentUser = JSON.parse(sessionStorage.getItem('currentUser'));
            if (!currentUser) {
                resultElement.innerHTML = '<p style="color: #ff5b5b;">请先登录</p>';
                return;
            }
            
            // 首先获取课程信息，以获取教师ID
            fetch(`/api/courses/${courseId}`)
                .then(response => response.json())
                .then(courseData => {
                    if (courseData.code === 200 && courseData.data) {
                        const teacherId = courseData.data.teacherId;
                        
                        const messageData = {
                            userId: teacherId,
                            title: title,
                            content: content,
                            sender: `${currentUser.realName || currentUser.username} (学生)`
                        };
                        
                        fetch('/api/messages/send', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(messageData)
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.code === 200) {
                                resultElement.innerHTML = '<p style="color: green;">消息发送成功！</p>';
                                
                                // 清空表单
                                document.getElementById('teacher-course').value = '';
                                document.getElementById('teacher-message-title').value = '';
                                document.getElementById('teacher-message-content').value = '';
                                
                                // 5秒后清除提示
                                setTimeout(() => {
                                    resultElement.innerHTML = '';
                                }, 5000);
                            } else {
                                resultElement.innerHTML = '<p style="color: #ff5b5b;">发送失败: ' + data.msg + '</p>';
                            }
                        })
                        .catch(error => {
                            console.error('发送消息失败:', error);
                            resultElement.innerHTML = '<p style="color: #ff5b5b;">发送消息失败，请稍后重试</p>';
                        });
                    } else {
                        resultElement.innerHTML = '<p style="color: #ff5b5b;">获取课程信息失败</p>';
                    }
                })
                .catch(error => {
                    console.error('获取课程信息失败:', error);
                    resultElement.innerHTML = '<p style="color: #ff5b5b;">获取课程信息失败，请稍后重试</p>';
                });
        }
        
        // 切换“发送对象”（管理员 / 任课教师）时显示对应表单
        function onMessageTargetTypeChange() {
            const typeSelect = document.getElementById('message-target-type');
            const adminBlock = document.getElementById('send-to-admin-block');
            const teacherBlock = document.getElementById('send-to-teacher-block');
            if (!typeSelect || !adminBlock || !teacherBlock) return;
            
            const value = typeSelect.value;
            if (value === 'teacher') {
                adminBlock.style.display = 'none';
                teacherBlock.style.display = 'block';
                // 确保课程下拉列表是最新的
                loadStudentCoursesForMessaging();
            } else {
                adminBlock.style.display = 'block';
                teacherBlock.style.display = 'none';
            }
        }
        
        // 退出登录功能
        function logout() {
            sessionStorage.removeItem('currentUser');
            window.location.href = 'login.html';
        }
    </script>
</body>
</html>